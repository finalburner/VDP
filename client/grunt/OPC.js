var async=require("async"),sql=require("mssql"),sleep=require("system-sleep"),opcua=require("node-opcua"),io=require("socket.io-client"),client=new opcua.OPCUAClient({keepSessionAlive:!0}),endpointUrl="opc.tcp://10.18.10.13:9080/CODRA/ComposerUAServer",the_session,the_subscription,ids,i=0,Write_Perm=!0,BATCH_MONITORING=0,WAIT=100,SELECT=0,Mnemo,list_AL,socket=io.connect("http://localhost:3000",{reconnect:!0,"connect timeout":2e3}),NodeId="ns=2;s=";io.connected===!1&&io.connecting===!1?(io.connect("http://localhost:4000"),console.log("Connected to client on 4000")):console.log("Connected to client on 3000");var sub_param=[{id:"Synthese.PresentCount",adr:"/Application/STEGC/Paris/_Entite/Synthese.PresentCount"},{id:"SyntheseMajeure.PresentCount",adr:"/Application/STEGC/Paris/_Entite/SyntheseMajeure.PresentCount"},{id:"SyntheseMineure.PresentCount",adr:"/Application/STEGC/Paris/_Entite/SyntheseMineure.PresentCount"},{id:"SyntheseDefCom.PresentCount",adr:"/Application/STEGC/Paris/_Entite/SyntheseDefCom.PresentCount"},{id:"SyntheseCritique.PresentCount",adr:"/Application/STEGC/Paris/_Entite/SyntheseCritique.PresentCount"}];socket.on("connect",function(){console.log("Socket connected <<>> Id :"+socket.id),socket.emit("OPC_Socket_Connected")}),socket.on("CT_Query",function(a){the_session&&(console.log("CT_query from "+a.Socket_ID),sql.connect(config_DONNEES).then(function(){(new sql.Request).query("Select distinct localisation,Installation_technique from dbo.SUPERVISION order by localisation").then(function(b){CT_PT_List=JSON.stringify(b),CT_PT_List=CT_PT_List.replace(/\s/g,""),CT_PT_List=JSON.parse(CT_PT_List),CT_PT_List.forEach(function(b){CT=b.localisation,PT=b.Installation_technique,AD=NodeId+"/Application/STEGC/Paris/PT/"+PT+"/_Entite/Adresse",CP=NodeId+"/Application/STEGC/Paris/PT/"+PT+"/_Entite/CodePostal",VI=NodeId+"/Application/STEGC/Paris/PT/"+PT+"/_Entite/Ville",LAT=NodeId+"/Application/STEGC/Paris/PT/"+PT+"/_Entite/Latitude",LONG=NodeId+"/Application/STEGC/Paris/PT/"+PT+"/_Entite/Longitude",AL_10=NodeId+"/Application/STEGC/Paris/PT/"+PT+"/_Entite/SyntheseDefCom/ExistPresent",AL_3=NodeId+"/Application/STEGC/Paris/PT/"+PT+"/_Entite/SyntheseCritique/ExistPresent",AL_2=NodeId+"/Application/STEGC/Paris/PT/"+PT+"/_Entite/SyntheseMajeure/ExistPresent",AL_1=NodeId+"/Application/STEGC/Paris/PT/"+PT+"/_Entite/SyntheseMineure/ExistPresent",the_session.readVariableValue([AD,CP,VI,LAT,LONG,AL_10,AL_3,AL_2,AL_1],function(c,d,e){if(c)console.log("diag >>>> "+e+" ---- Error >>>> "+c);else{d[0]&&d[1]&&d[2]&&d[0].value&&d[1].value&&d[2].value&&(b.ADR=d[0].value.value+" "+d[1].value.value+" "+d[2].value.value),d[3]&&d[3].value&&(b.LAT=d[3].value.value),d[4]&&d[4].value&&(b.LONG=d[4].value.value),d[5]&&d[5].value&&(b.AL_10=d[5].value.value),d[6]&&d[6].value&&(b.AL_3=d[6].value.value),d[7]&&d[7].value&&(b.AL_2=d[7].value.value),d[8]&&d[8].value&&(b.AL_1=d[8].value.value);var f=Object.assign({OPC_Socket_ID:a.OPC_Socket_ID,Socket_ID:a.Socket_ID},b);socket.emit("CT_Answer",f),console.log(d)}})})})["catch"](function(a){console.log(a)})})["catch"](function(a){console.log(a)})),the_session||socket.emit("Notif_All",{Msg:"OPC Session Error"})}),socket.on("Sta_Query",function(a){the_session?(console.log("Sta_Query from "+a.Socket_ID),sql.connect(config_DONNEES).then(function(){query="Select Installation_technique,DesignGroupeFonctionnel,DesignObjetFonctionnel,Information,Libelle_information,Type,TOR_CodeEtat1,TOR_CodeEtat0 from dbo.SUPERVISION ",query+="WHERE localisation = '"+a.Selected_CT+"' ",query+="AND NomGroupeFonctionnel = 'GENER' AND NomObjetFonctionnel = 'SYNTH' ",query+="AND Metier = 'CVC'",console.log(query),(new sql.Request).query(query).then(function(b){b=JSON.parse(JSON.stringify(b).replace(/"\s+|\s+"/g,'"')),b.forEach(function(b){b.Metier="CVC",b.NomGroupeFonctionnel="GENER",b.NomObjetFonctionnel="SYNTH",Mnemo=b.Metier+"_"+b.Installation_technique,Mnemo+="_"+b.NomGroupeFonctionnel+b.DesignGroupeFonctionnel,Mnemo+="_"+b.NomObjetFonctionnel+b.DesignObjetFonctionnel,Mnemo+="_"+b.Information,adr="/Application/STEGC/Paris/PT/"+b.Installation_technique,adr+="/Acquisition/"+Mnemo+".Valeur";var c="ns=2;s="+adr;b.Mnemo=Mnemo,the_session.readVariableValue(c,function(c,d,e){if(c)console.log("diag >>>> "+e+" ---- Error >>>> "+c);else if(console.dir(d),d&&d.value){b.Value=d.value.value,b.Value?b.Etat=b.TOR_CodeEtat1:b.Etat=b.TOR_CodeEtat0;var f=Object.assign({OPC_Socket_ID:a.OPC_Socket_ID,Socket_ID:a.Socket_ID},b);socket.emit("Sta_Answer",f),console.log(f)}})})})["catch"](function(a){console.log(a)})})["catch"](function(a){console.log(a)})):socket.emit("Notif_All",{Msg:"OPC Session Error"})}),socket.on("CTA_Query",function(a){if(the_session){console.log("CTA_Query : "+a.Socket_ID);var b="ns=2;s=";"null"==a.Selected_CT?console.log("No CT Selected"):(query="Select distinct Libelle_groupe,DesignGroupeFonctionnel,Installation_technique from dbo.SUPERVISION Where localisation ='"+a.Selected_CT+"' AND NomGroupeFonctionnel = 'CIRCU' AND Metier = 'CVC'",sql.connect(config_DONNEES).then(function(){(new sql.Request).query(query).then(function(c){c=JSON.parse(JSON.stringify(c).replace(/"\s+|\s+"/g,'"')),c&&c.forEach(function(c){PT=c.Installation_technique,Circuit=c.Libelle_groupe,Design=c.DesignGroupeFonctionnel,AMBIA="/STEGC/Paris/PT/"+PT+"/Acquisition/CVC_"+PT+"_CIRCU"+Design+"_TEMP3AMBIA_M01",DEPAR="/STEGC/Paris/PT/"+PT+"/Acquisition/CVC_"+PT+"_CIRCU"+Design+"_TEMP3DEPAR_M01",TEMP3_AMBIA=b+"/Application"+AMBIA+".Valeur",TEMP3_DEPAR=b+"/Application"+DEPAR+".Valeur",COURBE1="SELECT TOP 5 TriggeringValue  FROM dbo.Evenements_"+PT+" where Name = '"+AMBIA+"/Evt' ORDER BY UTC_App_DateTime DESC ",COURBE2="SELECT TOP 5 TriggeringValue  FROM dbo.Evenements_"+PT+" where Name = '"+DEPAR+"/Evt' ORDER BY UTC_App_DateTime DESC",the_session.readVariableValue([TEMP3_AMBIA,TEMP3_DEPAR],function(b,d,e){if(b)console.log("diag >>>> "+e+" ---- Error >>>> "+b);else{d[0]&&d[0].value&&(c.TEMP3_AMBIA=d[0].value.value,c.TEMP3_AMBIA_SRC=TEMP3_AMBIA),d[1]&&d[1].value&&(c.TEMP3_DEPAR=d[1].value.value,c.TEMP3_DEPAR_SRC=TEMP3_DEPAR);var f=Object.assign({OPC_Socket_ID:a.OPC_Socket_ID,Socket_ID:a.Socket_ID},c);socket.emit("CTA_Answer",f),console.log("CTA Emit ")}})})})["catch"](function(a){console.log(a)})})["catch"](function(a){console.log(a)}))}the_session||socket.emit("Notif_All",{Msg:"OPC Session Error"})}),socket.on("AL_Query",function(a){if(the_session){if("Read"==a.Mode){var b,c,d,e=[];console.dir(a),b="null"==a.Selected_CT?"Select top 300 * from dbo.SUPERVISION WHERE Type = 'TA' and Metier = 'CVC' ":"Select * from dbo.SUPERVISION WHERE Type = 'TA' and localisation ='"+a.Selected_CT+"'",sql.connect(config_DONNEES).then(function(){(new sql.Request).query(b).then(function(b){b&&(b=JSON.parse(JSON.stringify(b).replace(/"\s+|\s+"/g,'"')),b.forEach(function(a){Mnemo=a.Metier+"_"+a.Installation_technique,Mnemo+="_"+a.NomGroupeFonctionnel+a.DesignGroupeFonctionnel,Mnemo+="_"+a.NomObjetFonctionnel+a.DesignObjetFonctionnel,Mnemo+="_"+a.Information,adr="/Application/STEGC/Paris/PT/"+a.Installation_technique,adr+="/Acquisition/"+Mnemo;var b="ns=2;s="+adr;a.TOR_CriticiteAlarme&&a.Libelle_information&&e.push({NodeId:b,Mnemo:Mnemo,Libelle:a.Libelle_information,Criticite:a.TOR_CriticiteAlarme,Actif:"",Ack:""})}),e.forEach(function(b){alm_actif=b.NodeId+".valeur",alm_ack=b.NodeId+"/Alm/Acknowledged",the_session.readVariableValue([alm_actif,alm_ack],function(e,f,g){if(e)console.log("diag >>>> "+g+" ---- Error >>>> "+e);else if(console.log(b.Mnemo),f[0].statusCode&&(f[0].statusCode._base&&(b.StatusCode_Actif=f[0].statusCode._base.name,(b.StatusCode_Actif=f[0].value)&&(d=f[0].value.value)),f[0].statusCode.name&&(b.StatusCode_Actif=f[0].statusCode.name,(b.StatusCode_Actif=f[0].value)&&(d=f[0].value.value))),f[1].statusCode&&(f[1].statusCode._base&&(b.StatusCode_Ack=f[1].statusCode._base.name,(b.StatusCode_Ack=f[1].value)&&(c=f[1].value.value)),f[1].statusCode.name&&(b.StatusCode_Ack=f[1].statusCode.name,(b.StatusCode_Ack=f[1].value)&&(c=f[1].value.value))),!c||d){var h=Object.assign({OPC_Socket_ID:a.OPC_Socket_ID,Socket_ID:a.Socket_ID},b);socket.emit("AL_Answer",h)}})}))})["catch"](function(a){console.log("SQL QUERY ERROR :"),console.dir(a)})})}if("Write"==a.Mode&&(console.log(a),"ACK"==a.Type)){var f=[];f.push({objectId:opcua.resolveNodeId(a.NodeId+"/Alm"),methodId:opcua.resolveNodeId(a.NodeId+"/Alm.AckRequest"),inputArguments:[{dataType:opcua.DataType.String,arrayType:opcua.VariantArrayType.Scalar,value:"MobileVDP"},{dataType:opcua.DataType.String,arrayType:opcua.VariantArrayType.Scalar,value:"MobileVDP"}]}),the_session.call(f,function(b,c){c.length&&c[0].statusCode==opcua.StatusCodes.Good?(console.log("ACK done "),a.Ack=!0,socket.emit("Notif_Client",{Msg:a.Libelle+" acquitté(e)",Socket_ID:a.Socket_ID}),socket.emit("AL_Answer",a)):console.log(b)})}}the_session||socket.emit("Notif_All",{Msg:"OPC Session Error"})}),socket.on("Cons_Query",function(a){if(the_session){if("Read"==a.Mode){console.log(a);var b="ns=2;s=";a.Selected_CT&&a.Selected_Grp?(query="Select Metier, Installation_technique, NomGroupeFonctionnel, ",query+=" DesignGroupeFonctionnel , NomObjetFonctionnel ,  DesignObjetFonctionnel ,",query+=" Information, Libelle_groupe, Libelle_information, Type, ANA_Unite, ANA_ValeurMini, ANA_ValeurMaxi, ",query+=" TOR_CodeEtat0, TOR_CodeEtat1 from dbo.SUPERVISION WHERE Localisation ='"+a.Selected_CT+"'",query+=" AND NomGroupeFonctionnel = 'CIRCU' AND DesignGroupeFonctionnel= '"+a.Selected_Grp,query+="' AND Type IN ('TC' , 'TR') AND Metier = 'CVC' order by Type "):query="Select Metier, Installation_technique, NomGroupeFonctionnel, DesignGroupeFonctionnel , NomObjetFonctionnel ,  DesignObjetFonctionnel , Information, Libelle_groupe, Libelle_information, Type, ANA_Unite, ANA_ValeurMini, ANA_ValeurMaxi, TOR_CodeEtat0, TOR_CodeEtat1 from dbo.SUPERVISION Where Localisation ='CT93213' AND NomGroupeFonctionnel = 'CIRCU' AND Type IN ('TC' , 'TR') AND metier = 'CVC' order by Type ",sql.connect(config_DONNEES).then(function(){(new sql.Request).query(query).then(function(c){c=JSON.parse(JSON.stringify(c).replace(/"\s+|\s+"/g,'"')),c&&c.forEach(function(c){Mnemo=c.Metier+"_"+c.Installation_technique,Mnemo+="_"+c.NomGroupeFonctionnel+c.DesignGroupeFonctionnel,Mnemo+="_"+c.NomObjetFonctionnel+c.DesignObjetFonctionnel,Mnemo+="_"+c.Information,c.Mnemo=Mnemo,adr="/Application/STEGC/Paris/PT/"+c.Installation_technique,adr+="/Acquisition/"+Mnemo,c.adr=b+adr+".Valeur",the_session.readVariableValue(c.adr,function(b,d,e){if(b)console.log("diag >>>> "+e+" ---- Error >>>> "+b);else if(d&&d.value){c.Value=d.value.value,c.Local_Value=c.Value;var f=Object.assign({OPC_Socket_ID:a.OPC_Socket_ID,Socket_ID:a.Socket_ID},c);socket.emit("Cons_Answer",f),console.log(f)}})})})})}if("Write"==a.Mode&&Write_Perm){if("TC"==a.Type){console.log(a.adr);var c=[{nodeId:opcua.resolveNodeId(a.adr),attributeId:opcua.AttributeIds.Value,indexRange:null,value:{value:{dataType:opcua.DataType.Boolean,value:a.Local_Value}}}]}if("TR"==a.Type){console.log(a);var c=[{nodeId:opcua.resolveNodeId(a.adr),attributeId:opcua.AttributeIds.Value,indexRange:null,value:{value:{dataType:opcua.DataType.Double,value:a.Local_Value}}}]}the_session.write(c,function(b,d){b?console.log(b):(console.log(d.length+"--"+c.length),console.log(d[0]+"--"+opcua.StatusCodes.BadNotWritable),console.log(d+"--"+opcua.StatusCodes.Good),the_session.readVariableValue(a.adr,function(b,c,d){b?console.log("diag >>>> "+d+" ---- Error >>>> "+b):c&&c.value&&(console.log(c),a.Value=c.value.value,socket.emit("Notif_Client",{Msg:a.Libelle_information+" changé à '"+a.Value+"'",Socket_ID:a.Socket_ID}),socket.emit("Cons_Answer_Update",a))}))})}}the_session||socket.emit("Notif_All",{Msg:"OPC Session Error"})});var config_DONNEES={user:"BdConnectClient",password:"Uuxwp7Mcxo7Khy",server:"10.18.10.3\\MSSQLSERVER",database:"DONNEES",options:{encrypt:!0}},config_ARCHIVES={user:"BdConnectClient",password:"Uuxwp7Mcxo7Khy",server:"10.18.10.3\\MSSQLSERVER",database:"ARCHIVES",options:{encrypt:!0}};async.series([function(a){sql.connect(config_DONNEES).then(function(){console.log("MS SQL connected success"),(new sql.Request).query("select TOP "+SELECT+" * from dbo.SUPERVISION  ").then(function(b){ids=JSON.parse(JSON.stringify(b).replace(/"\s+|\s+"/g,'"')),console.log(Object.keys(ids).length),a()})["catch"](function(a){console.log(a.name+" --> "+a.code+" : "+a.message)})})["catch"](function(a){console.log(a.name+" --> "+a.code+" : "+a.message)})},function(a){client.connect(endpointUrl,function(b){b?console.log(" cannot connect to endpoint :",endpointUrl):console.log("OPC connected !"),a(b)})},function(a){client.createSession(function(b,c){b||(the_session=c,console.log("Session Ok !")),a(b)})},function(a){init_OPC_sub=new opcua.ClientSubscription(the_session,{requestedPublishingInterval:1e3,requestedLifetimeCount:10,requestedMaxKeepAliveCount:2,maxNotificationsPerPublish:1,publishingEnabled:!0,priority:8}),sub_param.forEach(function(a){var b="ns=2;s="+a.adr,c=init_OPC_sub.monitor({nodeId:opcua.resolveNodeId(b),attributeId:opcua.AttributeIds.Value},{samplingInterval:1e3,discardOldest:!1,queueSize:1},opcua.read_service.TimestampsToReturn.Both);c.on("changed",function(b){null!=b.value&&(a.value=b.value.value,socket.emit("OPC_General_Update",a))})}),a()},function(a){the_subscription=new opcua.ClientSubscription(the_session,{requestedPublishingInterval:100,maxNotificationsPerPublish:1,publishingEnabled:!0,priority:10}),ids.forEach(function(a){if(BATCH_MONITORING>i){var b;Mnemo=a.Metier+"_"+a.Installation_technique,Mnemo+="_"+a.NomGroupeFonctionnel+a.DesignGroupeFonctionnel,Mnemo+="_"+a.NomObjetFonctionnel+a.DesignObjetFonctionne,Mnemo+="_"+a.Information,b="/Application/STEGC/Paris/PT/"+a.Installation_technique,b+="/Acquisition/"+Mnemo+".Valeur";var c="ns=2;s="+b,d=the_subscription.monitor({nodeId:opcua.resolveNodeId(c),attributeId:opcua.AttributeIds.Value},{samplingInterval:1e3,discardOldest:!1,queueSize:10},opcua.read_service.TimestampsToReturn.Both);d.on("changed",function(b){null!=b.value&&(a.Value=b.value.value),socket.emit("OPC_Update",a)}),i++}else sleep(WAIT),console.log("wait"),i=0}),console.log("Subscription Finished")},function(a){the_session.close(function(a){a&&console.log("session closed failed ?")})}],function(a){a?console.log(" failure ",a):console.log("done!"),client.disconnect(function(){})});