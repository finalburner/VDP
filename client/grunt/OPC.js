var async=require("async"),sql=require("mssql"),sleep=require("system-sleep"),opcua=require("node-opcua"),io=require("socket.io-client"),client=new opcua.OPCUAClient({keepSessionAlive:!0}),endpointUrl="opc.tcp://10.18.10.13:9080/CODRA/ComposerUAServer",the_session,the_subscription,ids,i=0,Write_Perm=!0,BATCH_MONITORING=0,WAIT=100,SELECT=0,Mnemo,list_AL,socket=io.connect("http://localhost:3000",{reconnect:!0,"connect timeout":2e3}),NodeId="ns=2;s=";!1===io.connected&&!1===io.connecting?(io.connect("http://localhost:4000"),console.log("Connected to client on 4000")):console.log("Connected to client on 3000");var sub_param=[{id:"Synthese.PresentCount",adr:"/Application/STEGC/Paris/_Entite/Synthese.PresentCount"},{id:"SyntheseMajeure.PresentCount",adr:"/Application/STEGC/Paris/_Entite/SyntheseMajeure.PresentCount"},{id:"SyntheseMineure.PresentCount",adr:"/Application/STEGC/Paris/_Entite/SyntheseMineure.PresentCount"},{id:"SyntheseDefCom.PresentCount",adr:"/Application/STEGC/Paris/_Entite/SyntheseDefCom.PresentCount"},{id:"SyntheseCritique.PresentCount",adr:"/Application/STEGC/Paris/_Entite/SyntheseCritique.PresentCount"}];socket.on("connect",function(){console.log("Socket connected <<>> Id :"+socket.id),socket.emit("OPC_Socket_Connected")}),socket.on("CT_Query",function(e){the_session&&(console.log("CT_query from "+e.Socket_ID),sql.connect(config_DONNEES).then(function(){(new sql.Request).query("Select distinct localisation,Installation_technique from dbo.SUPERVISION order by localisation").then(function(o){CT_PT_List=JSON.stringify(o),CT_PT_List=CT_PT_List.replace(/\s/g,""),CT_PT_List=JSON.parse(CT_PT_List),CT_PT_List.forEach(function(o){CT=o.localisation,PT=o.Installation_technique,AD=NodeId+"/Application/STEGC/Paris/PT/"+PT+"/_Entite/Adresse",CP=NodeId+"/Application/STEGC/Paris/PT/"+PT+"/_Entite/CodePostal",VI=NodeId+"/Application/STEGC/Paris/PT/"+PT+"/_Entite/Ville",LAT=NodeId+"/Application/STEGC/Paris/PT/"+PT+"/_Entite/Latitude",LONG=NodeId+"/Application/STEGC/Paris/PT/"+PT+"/_Entite/Longitude",AL_10=NodeId+"/Application/STEGC/Paris/PT/"+PT+"/_Entite/SyntheseDefCom/ExistPresent",AL_3=NodeId+"/Application/STEGC/Paris/PT/"+PT+"/_Entite/SyntheseCritique/ExistPresent",AL_2=NodeId+"/Application/STEGC/Paris/PT/"+PT+"/_Entite/SyntheseMajeure/ExistPresent",AL_1=NodeId+"/Application/STEGC/Paris/PT/"+PT+"/_Entite/SyntheseMineure/ExistPresent",the_session.readVariableValue([AD,CP,VI,LAT,LONG,AL_10,AL_3,AL_2,AL_1],function(n,t,i){if(n)console.log("diag >>>> "+i+" ---- Error >>>> "+n);else{t[0]&&t[1]&&t[2]&&t[0].value&&t[1].value&&t[2].value&&(o.ADR=t[0].value.value+" "+t[1].value.value+" "+t[2].value.value),t[3]&&t[3].value&&(o.LAT=t[3].value.value),t[4]&&t[4].value&&(o.LONG=t[4].value.value),t[5]&&t[5].value&&(o.AL_10=t[5].value.value),t[6]&&t[6].value&&(o.AL_3=t[6].value.value),t[7]&&t[7].value&&(o.AL_2=t[7].value.value),t[8]&&t[8].value&&(o.AL_1=t[8].value.value);var s=Object.assign({OPC_Socket_ID:e.OPC_Socket_ID,Socket_ID:e.Socket_ID},o);socket.emit("CT_Answer",s),console.log(t)}})})}).catch(function(e){console.log(e)})}).catch(function(e){console.log(e)})),the_session||socket.emit("Notif_All",{Msg:"OPC Session Error"})}),socket.on("Sta_Query",function(e){the_session?(console.log("Sta_Query from "+e.Socket_ID),sql.connect(config_DONNEES).then(function(){query="Select Installation_technique,DesignGroupeFonctionnel,DesignObjetFonctionnel,Information,Libelle_information,Type,TOR_CodeEtat1,TOR_CodeEtat0 from dbo.SUPERVISION ",query+="WHERE localisation = '"+e.Selected_CT+"' ",query+="AND NomGroupeFonctionnel = 'GENER' AND NomObjetFonctionnel = 'SYNTH' ",query+="AND Metier = 'CVC'",console.log(query),(new sql.Request).query(query).then(function(o){(o=JSON.parse(JSON.stringify(o).replace(/"\s+|\s+"/g,'"'))).forEach(function(o){o.Metier="CVC",o.NomGroupeFonctionnel="GENER",o.NomObjetFonctionnel="SYNTH",Mnemo=o.Metier+"_"+o.Installation_technique,Mnemo+="_"+o.NomGroupeFonctionnel+o.DesignGroupeFonctionnel,Mnemo+="_"+o.NomObjetFonctionnel+o.DesignObjetFonctionnel,Mnemo+="_"+o.Information,adr="/Application/STEGC/Paris/PT/"+o.Installation_technique,adr+="/Acquisition/"+Mnemo+".Valeur";var n="ns=2;s="+adr;o.Mnemo=Mnemo,the_session.readVariableValue(n,function(n,t,i){if(n)console.log("diag >>>> "+i+" ---- Error >>>> "+n);else if(console.dir(t),t&&t.value){o.Value=t.value.value,o.Value?o.Etat=o.TOR_CodeEtat1:o.Etat=o.TOR_CodeEtat0;var s=Object.assign({OPC_Socket_ID:e.OPC_Socket_ID,Socket_ID:e.Socket_ID},o);socket.emit("Sta_Answer",s),console.log(s)}})})}).catch(function(e){console.log(e)})}).catch(function(e){console.log(e)})):socket.emit("Notif_All",{Msg:"OPC Session Error"})}),socket.on("CTA_Query",function(e){if(the_session){console.log("CTA_Query : "+e.Socket_ID);var o="ns=2;s=";"null"==e.Selected_CT?console.log("No CT Selected"):(query="Select distinct Libelle_groupe,DesignGroupeFonctionnel,Installation_technique from dbo.SUPERVISION Where localisation ='"+e.Selected_CT+"' AND NomGroupeFonctionnel = 'CIRCU' AND Metier = 'CVC'",sql.connect(config_DONNEES).then(function(){(new sql.Request).query(query).then(function(n){(n=JSON.parse(JSON.stringify(n).replace(/"\s+|\s+"/g,'"')))&&n.forEach(function(n){PT=n.Installation_technique,Circuit=n.Libelle_groupe,Design=n.DesignGroupeFonctionnel,AMBIA="/STEGC/Paris/PT/"+PT+"/Acquisition/CVC_"+PT+"_CIRCU"+Design+"_TEMP3AMBIA_M01",DEPAR="/STEGC/Paris/PT/"+PT+"/Acquisition/CVC_"+PT+"_CIRCU"+Design+"_TEMP3DEPAR_M01",TEMP3_AMBIA=o+"/Application"+AMBIA+".Valeur",TEMP3_DEPAR=o+"/Application"+DEPAR+".Valeur",COURBE1="SELECT TOP 5 TriggeringValue  FROM dbo.Evenements_"+PT+" where Name = '"+AMBIA+"/Evt' ORDER BY UTC_App_DateTime DESC ",COURBE2="SELECT TOP 5 TriggeringValue  FROM dbo.Evenements_"+PT+" where Name = '"+DEPAR+"/Evt' ORDER BY UTC_App_DateTime DESC",the_session.readVariableValue([TEMP3_AMBIA,TEMP3_DEPAR],function(o,t,i){if(o)console.log("diag >>>> "+i+" ---- Error >>>> "+o);else{t[0]&&t[0].value&&(n.TEMP3_AMBIA=t[0].value.value,n.TEMP3_AMBIA_SRC=TEMP3_AMBIA),t[1]&&t[1].value&&(n.TEMP3_DEPAR=t[1].value.value,n.TEMP3_DEPAR_SRC=TEMP3_DEPAR);var s=Object.assign({OPC_Socket_ID:e.OPC_Socket_ID,Socket_ID:e.Socket_ID},n);socket.emit("CTA_Answer",s),console.log("CTA Emit ")}})})}).catch(function(e){console.log(e)})}).catch(function(e){console.log(e)}))}the_session||socket.emit("Notif_All",{Msg:"OPC Session Error"})}),socket.on("AL_Query",function(e){if(the_session){if("Read"==e.Mode){var o,n,t,i=[];console.dir(e),o="null"==e.Selected_CT?"Select top 300 * from dbo.SUPERVISION WHERE Type = 'TA' and Metier = 'CVC' ":"Select * from dbo.SUPERVISION WHERE Type = 'TA' and localisation ='"+e.Selected_CT+"'",sql.connect(config_DONNEES).then(function(){(new sql.Request).query(o).then(function(o){o&&((o=JSON.parse(JSON.stringify(o).replace(/"\s+|\s+"/g,'"'))).forEach(function(e){Mnemo=e.Metier+"_"+e.Installation_technique,Mnemo+="_"+e.NomGroupeFonctionnel+e.DesignGroupeFonctionnel,Mnemo+="_"+e.NomObjetFonctionnel+e.DesignObjetFonctionnel,Mnemo+="_"+e.Information,adr="/Application/STEGC/Paris/PT/"+e.Installation_technique,adr+="/Acquisition/"+Mnemo;var o="ns=2;s="+adr;e.TOR_CriticiteAlarme&&e.Libelle_information&&i.push({NodeId:o,Mnemo:Mnemo,Libelle:e.Libelle_information,Criticite:e.TOR_CriticiteAlarme,Actif:"",Ack:""})}),i.forEach(function(o){alm_actif=o.NodeId+".valeur",alm_ack=o.NodeId+"/Alm/Acknowledged",the_session.readVariableValue([alm_actif,alm_ack],function(i,s,a){if(i)console.log("diag >>>> "+a+" ---- Error >>>> "+i);else if(console.log(o.Mnemo),s[0].statusCode&&(s[0].statusCode._base&&(o.StatusCode_Actif=s[0].statusCode._base.name,(o.StatusCode_Actif=s[0].value)&&(t=s[0].value.value)),s[0].statusCode.name&&(o.StatusCode_Actif=s[0].statusCode.name,(o.StatusCode_Actif=s[0].value)&&(t=s[0].value.value))),s[1].statusCode&&(s[1].statusCode._base&&(o.StatusCode_Ack=s[1].statusCode._base.name,(o.StatusCode_Ack=s[1].value)&&(n=s[1].value.value)),s[1].statusCode.name&&(o.StatusCode_Ack=s[1].statusCode.name,(o.StatusCode_Ack=s[1].value)&&(n=s[1].value.value))),!n||t){var l=Object.assign({OPC_Socket_ID:e.OPC_Socket_ID,Socket_ID:e.Socket_ID},o);socket.emit("AL_Answer",l)}})}))}).catch(function(e){console.log("SQL QUERY ERROR :"),console.dir(e)})})}if("Write"==e.Mode&&(console.log(e),"ACK"==e.Type)){var s=[];s.push({objectId:opcua.resolveNodeId(e.NodeId+"/Alm"),methodId:opcua.resolveNodeId(e.NodeId+"/Alm.AckRequest"),inputArguments:[{dataType:opcua.DataType.String,arrayType:opcua.VariantArrayType.Scalar,value:"MobileVDP"},{dataType:opcua.DataType.String,arrayType:opcua.VariantArrayType.Scalar,value:"MobileVDP"}]}),the_session.call(s,function(o,n){n.length&&n[0].statusCode==opcua.StatusCodes.Good?(console.log("ACK done "),e.Ack=!0,socket.emit("Notif_Client",{Msg:e.Libelle+" acquitté(e)",Socket_ID:e.Socket_ID}),socket.emit("AL_Answer",e)):console.log(o)})}}the_session||socket.emit("Notif_All",{Msg:"OPC Session Error"})}),socket.on("Cons_Query",function(e){if(the_session&&("Read"==e.Mode&&(console.log(e),e.Selected_CT&&e.Selected_Grp?(query="Select Metier, Installation_technique, NomGroupeFonctionnel, ",query+=" DesignGroupeFonctionnel , NomObjetFonctionnel ,  DesignObjetFonctionnel ,",query+=" Information, Libelle_groupe, Libelle_information, Type, ANA_Unite, ANA_ValeurMini, ANA_ValeurMaxi, ",query+=" TOR_CodeEtat0, TOR_CodeEtat1 from dbo.SUPERVISION WHERE Localisation ='"+e.Selected_CT+"'",query+=" AND NomGroupeFonctionnel = 'CIRCU' AND DesignGroupeFonctionnel= '"+e.Selected_Grp,query+="' AND Type IN ('TC' , 'TR') AND Metier = 'CVC' order by Type "):query="Select Metier, Installation_technique, NomGroupeFonctionnel, DesignGroupeFonctionnel , NomObjetFonctionnel ,  DesignObjetFonctionnel , Information, Libelle_groupe, Libelle_information, Type, ANA_Unite, ANA_ValeurMini, ANA_ValeurMaxi, TOR_CodeEtat0, TOR_CodeEtat1 from dbo.SUPERVISION Where Localisation ='CT93213' AND NomGroupeFonctionnel = 'CIRCU' AND Type IN ('TC' , 'TR') AND metier = 'CVC' order by Type ",sql.connect(config_DONNEES).then(function(){(new sql.Request).query(query).then(function(o){(o=JSON.parse(JSON.stringify(o).replace(/"\s+|\s+"/g,'"')))&&o.forEach(function(o){Mnemo=o.Metier+"_"+o.Installation_technique,Mnemo+="_"+o.NomGroupeFonctionnel+o.DesignGroupeFonctionnel,Mnemo+="_"+o.NomObjetFonctionnel+o.DesignObjetFonctionnel,Mnemo+="_"+o.Information,o.Mnemo=Mnemo,adr="/Application/STEGC/Paris/PT/"+o.Installation_technique,adr+="/Acquisition/"+Mnemo,o.adr="ns=2;s="+adr+".Valeur",the_session.readVariableValue(o.adr,function(n,t,i){if(n)console.log("diag >>>> "+i+" ---- Error >>>> "+n);else if(t&&t.value){o.Value=t.value.value,o.Local_Value=o.Value;var s=Object.assign({OPC_Socket_ID:e.OPC_Socket_ID,Socket_ID:e.Socket_ID},o);socket.emit("Cons_Answer",s),console.log(s)}})})})})),"Write"==e.Mode&&Write_Perm)){if("TC"==e.Type&&(console.log(e.adr),o=[{nodeId:opcua.resolveNodeId(e.adr),attributeId:opcua.AttributeIds.Value,indexRange:null,value:{value:{dataType:opcua.DataType.Boolean,value:e.Local_Value}}}]),"TR"==e.Type){console.log(e);var o=[{nodeId:opcua.resolveNodeId(e.adr),attributeId:opcua.AttributeIds.Value,indexRange:null,value:{value:{dataType:opcua.DataType.Double,value:e.Local_Value}}}]}the_session.write(o,function(n,t){n?console.log(n):(console.log(t.length+"--"+o.length),console.log(t[0]+"--"+opcua.StatusCodes.BadNotWritable),console.log(t+"--"+opcua.StatusCodes.Good),the_session.readVariableValue(e.adr,function(o,n,t){o?console.log("diag >>>> "+t+" ---- Error >>>> "+o):n&&n.value&&(console.log(n),e.Value=n.value.value,socket.emit("Notif_Client",{Msg:e.Libelle_information+" changé à '"+e.Value+"'",Socket_ID:e.Socket_ID}),socket.emit("Cons_Answer_Update",e))}))})}the_session||socket.emit("Notif_All",{Msg:"OPC Session Error"})});var config_DONNEES={user:"BdConnectClient",password:"Uuxwp7Mcxo7Khy",server:"10.18.10.3\\MSSQLSERVER",database:"DONNEES",options:{encrypt:!0}},config_ARCHIVES={user:"BdConnectClient",password:"Uuxwp7Mcxo7Khy",server:"10.18.10.3\\MSSQLSERVER",database:"ARCHIVES",options:{encrypt:!0}};async.series([function(e){sql.connect(config_DONNEES).then(function(){console.log("MS SQL connected success"),(new sql.Request).query("select TOP "+SELECT+" * from dbo.SUPERVISION  ").then(function(o){ids=JSON.parse(JSON.stringify(o).replace(/"\s+|\s+"/g,'"')),console.log(Object.keys(ids).length),e()}).catch(function(e){console.log(e.name+" --\x3e "+e.code+" : "+e.message)})}).catch(function(e){console.log(e.name+" --\x3e "+e.code+" : "+e.message)})},function(e){client.connect(endpointUrl,function(o){o?console.log(" cannot connect to endpoint :",endpointUrl):console.log("OPC connected !"),e(o)})},function(e){client.createSession(function(o,n){o||(the_session=n,console.log("Session Ok !")),e(o)})},function(e){init_OPC_sub=new opcua.ClientSubscription(the_session,{requestedPublishingInterval:1e3,requestedLifetimeCount:10,requestedMaxKeepAliveCount:2,maxNotificationsPerPublish:1,publishingEnabled:!0,priority:8}),sub_param.forEach(function(e){var o="ns=2;s="+e.adr;init_OPC_sub.monitor({nodeId:opcua.resolveNodeId(o),attributeId:opcua.AttributeIds.Value},{samplingInterval:1e3,discardOldest:!1,queueSize:1},opcua.read_service.TimestampsToReturn.Both).on("changed",function(o){null!=o.value&&(e.value=o.value.value,socket.emit("OPC_General_Update",e))})}),e()},function(e){the_subscription=new opcua.ClientSubscription(the_session,{requestedPublishingInterval:100,maxNotificationsPerPublish:1,publishingEnabled:!0,priority:10}),ids.forEach(function(e){if(BATCH_MONITORING>i){var o;Mnemo=e.Metier+"_"+e.Installation_technique,Mnemo+="_"+e.NomGroupeFonctionnel+e.DesignGroupeFonctionnel,Mnemo+="_"+e.NomObjetFonctionnel+e.DesignObjetFonctionne,Mnemo+="_"+e.Information,o="/Application/STEGC/Paris/PT/"+e.Installation_technique;var n="ns=2;s="+(o+="/Acquisition/"+Mnemo+".Valeur");the_subscription.monitor({nodeId:opcua.resolveNodeId(n),attributeId:opcua.AttributeIds.Value},{samplingInterval:1e3,discardOldest:!1,queueSize:10},opcua.read_service.TimestampsToReturn.Both).on("changed",function(o){null!=o.value&&(e.Value=o.value.value),socket.emit("OPC_Update",e)}),i++}else sleep(WAIT),console.log("wait"),i=0}),console.log("Subscription Finished")},function(e){the_session.close(function(e){e&&console.log("session closed failed ?")})}],function(e){e?console.log(" failure ",e):console.log("done!"),client.disconnect(function(){})});